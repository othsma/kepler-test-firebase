import{j as e}from"./vendor-pdf-renderer-DJMoKmcy.js";import{r as d}from"./vendor-react-DSd34EeT.js";import{u as _,k as X,b as G,U as J,l as H}from"./index-D_7Gp2H0.js";import{X as K,p as O,r as W,T as Y,N as Z,m as q,A as ee,n as te,O as se,J as ae,k as R,y as V,Q as U,D as re,x as P,V as le}from"./vendor-ui-CfnjVJp_.js";import{f as B}from"./vendor-utils-BOCFPwNx.js";import"./vendor-firebase-CWMDWzYz.js";import"./vendor-pdf-utils-CBrSDip1.js";function ie({quote:r,clients:h,onClose:N,onSave:F}){var w,D,T,s;const l=_(t=>t.isDarkMode),[C,x]=d.useState({...r}),[p,Q]=d.useState(((w=r.customer)==null?void 0:w.id)||""),[o,E]=d.useState(""),[y,b]=d.useState(!1),[m,M]=d.useState(r.notes||""),u=((D=C.items)==null?void 0:D.reduce((t,a)=>t+a.price*a.quantity,0))||0,S=.2,j=u*(S/(1+S)),g=u-j;d.useEffect(()=>{x(t=>({...t,subtotal:u,tax:j,total:g}))},[u,j,g]);const k=h.filter(t=>t.name.toLowerCase().includes(o.toLowerCase())||t.email.toLowerCase().includes(o.toLowerCase())||t.phone.toLowerCase().includes(o.toLowerCase())),v=(t,a)=>{a<=0?x(i=>({...i,items:i.items.filter((n,c)=>c!==t)})):x(i=>({...i,items:i.items.map((n,c)=>c===t?{...n,quantity:a}:n)}))},A=()=>{const t={productId:`custom-${Date.now()}`,quantity:1,name:"Nouvel article",price:0,sku:"CUSTOM"};x(a=>({...a,items:[...a.items||[],t]}))},f=(t,a,i)=>{x(n=>({...n,items:n.items.map((c,z)=>z===t?{...c,[a]:i}:c)}))},$=t=>{x(a=>({...a,items:a.items.filter((i,n)=>n!==t)}))},I=t=>{Q(t.id),x(a=>({...a,customer:{id:t.id,name:t.name,...t.email&&{email:t.email},...t.phone&&{phone:t.phone},...t.address&&{address:t.address}}})),E(""),b(!1)},L=()=>{const t={...C,notes:m.trim()||void 0};F(t)};return e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50",onClick:N}),e.jsxs("div",{className:`relative w-full max-w-4xl max-h-[90vh] overflow-y-auto rounded-lg shadow-xl ${l?"bg-gray-800":"bg-white"} p-6`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h2",{className:`text-2xl font-semibold ${l?"text-white":"text-gray-900"}`,children:["Modifier le devis ",r.quoteNumber]}),e.jsx("button",{onClick:N,className:`p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 ${l?"text-gray-400":"text-gray-600"}`,children:e.jsx(K,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:`block text-sm font-medium mb-2 ${l?"text-gray-300":"text-gray-700"}`,children:"Client"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:p&&((T=h.find(t=>t.id===p))==null?void 0:T.name)||o,onChange:t=>{E(t.target.value),b(!0),p&&Q("")},onFocus:()=>b(!0),onBlur:()=>setTimeout(()=>b(!1),200),placeholder:"Rechercher un client...",className:`w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 ${l?"bg-gray-700 border-gray-600 text-white":"bg-white"}`}),y&&k.length>0&&e.jsx("div",{className:`absolute z-10 w-full mt-1 rounded-md shadow-lg border ${l?"bg-gray-800 border-gray-700":"bg-white border-gray-200"} max-h-60 overflow-y-auto`,children:k.map(t=>e.jsxs("div",{className:`px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer ${p===t.id?"bg-indigo-50 dark:bg-indigo-900":""}`,onClick:()=>I(t),children:[e.jsx("div",{className:"font-medium",children:t.name}),e.jsx("div",{className:"text-sm text-gray-500",children:t.phone})]},t.id))})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("label",{className:`block text-sm font-medium ${l?"text-gray-300":"text-gray-700"}`,children:"Articles"}),e.jsxs("button",{onClick:A,className:"bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700 text-sm flex items-center gap-1",children:[e.jsx(O,{className:"h-4 w-4"}),"Ajouter"]})]}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:(s=C.items)==null?void 0:s.map((t,a)=>e.jsx("div",{className:`flex items-center gap-4 p-4 rounded-lg border ${l?"bg-gray-700 border-gray-600":"bg-gray-50 border-gray-200"}`,children:e.jsxs("div",{className:"flex-1 grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"Nom"}),e.jsx("input",{type:"text",value:t.name,onChange:i=>f(a,"name",i.target.value),className:`w-full rounded border-gray-300 text-sm ${l?"bg-gray-600 border-gray-500 text-white":"bg-white"}`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"Prix (€)"}),e.jsx("input",{type:"number",step:"0.01",value:t.price,onChange:i=>f(a,"price",parseFloat(i.target.value)||0),className:`w-full rounded border-gray-300 text-sm ${l?"bg-gray-600 border-gray-500 text-white":"bg-white"}`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"Quantité"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>v(a,t.quantity-1),className:"p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-600",children:e.jsx(W,{className:"h-4 w-4"})}),e.jsx("input",{type:"number",min:"1",value:t.quantity,onChange:i=>v(a,parseInt(i.target.value)||1),className:`w-16 text-center rounded border-gray-300 text-sm ${l?"bg-gray-600 border-gray-500 text-white":"bg-white"}`}),e.jsx("button",{onClick:()=>v(a,t.quantity+1),className:"p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-600",children:e.jsx(O,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:e.jsxs("div",{className:"text-sm font-medium",children:["€",(t.price*t.quantity).toFixed(2)]})}),e.jsx("button",{onClick:()=>$(a),className:"text-red-600 hover:text-red-900 p-1",title:"Supprimer",children:e.jsx(Y,{className:"h-4 w-4"})})]})]})},a))})]}),e.jsx("div",{className:`rounded-lg p-4 ${l?"bg-gray-700":"bg-gray-50"}`,children:e.jsx("div",{className:"flex justify-end",children:e.jsxs("div",{className:"w-64 space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:l?"text-gray-300":"text-gray-600",children:"Sous-total"}),e.jsxs("span",{className:l?"text-white":"text-gray-900",children:["€",u.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:l?"text-gray-300":"text-gray-600",children:"TVA (20%)"}),e.jsxs("span",{className:l?"text-white":"text-gray-900",children:["€",j.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between font-bold text-lg pt-2 border-t border-gray-300 dark:border-gray-600",children:[e.jsx("span",{className:l?"text-white":"text-gray-900",children:"Total"}),e.jsxs("span",{className:l?"text-white":"text-gray-900",children:["€",g.toFixed(2)]})]})]})})}),e.jsxs("div",{children:[e.jsx("label",{className:`block text-sm font-medium mb-2 ${l?"text-gray-300":"text-gray-700"}`,children:"Notes (optionnel)"}),e.jsx("textarea",{value:m,onChange:t=>M(t.target.value),rows:3,className:`w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 ${l?"bg-gray-700 border-gray-600 text-white":"bg-white"}`,placeholder:"Ajouter des notes au devis..."})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("button",{type:"button",onClick:N,className:`px-4 py-2 border rounded-md text-sm font-medium ${l?"border-gray-600 text-gray-300 hover:bg-gray-700":"border-gray-300 text-gray-700 hover:bg-gray-50"}`,children:"Annuler"}),e.jsxs("button",{type:"button",onClick:L,className:"px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm font-medium flex items-center gap-2",children:[e.jsx(Z,{className:"h-4 w-4"}),"Enregistrer les modifications"]})]})]})]})]})}function ge(){const r=_(s=>s.isDarkMode),{quotes:h,loading:N,error:F,fetchQuotes:l,updateQuote:C,updateQuoteStatus:x,convertQuoteToSale:p}=X(),{clients:Q}=G(),[o,E]=d.useState(""),[y,b]=d.useState("all"),[m,M]=d.useState("desc"),[u,S]=d.useState(!1),[j,g]=d.useState(!1),[k,v]=d.useState(null),[A,f]=d.useState(null);d.useEffect(()=>{l()},[l]);const $=d.useMemo(()=>{let s=h.filter(t=>{var n;const a=o===""||t.quoteNumber.toLowerCase().includes(o.toLowerCase())||(((n=t.customer)==null?void 0:n.name)||"").toLowerCase().includes(o.toLowerCase())||t.items.some(c=>c.name.toLowerCase().includes(o.toLowerCase())),i=y==="all"||t.status===y;return a&&i});return s.sort((t,a)=>{const i=new Date(t.createdAt).getTime(),n=new Date(a.createdAt).getTime();return m==="desc"?n-i:i-n}),s},[h,o,y,m]),I=s=>{switch(s){case"draft":return"bg-gray-100 text-gray-800";case"sent":return"bg-blue-100 text-blue-800";case"accepted":return"bg-green-100 text-green-800";case"rejected":return"bg-red-100 text-red-800";case"expired":return"bg-yellow-100 text-yellow-800";default:return"bg-gray-100 text-gray-800"}},L=s=>{switch(s){case"draft":return e.jsx(P,{className:"h-4 w-4"});case"sent":return e.jsx(R,{className:"h-4 w-4"});case"accepted":return e.jsx(V,{className:"h-4 w-4"});case"rejected":return e.jsx(U,{className:"h-4 w-4"});case"expired":return e.jsx(le,{className:"h-4 w-4"});default:return e.jsx(P,{className:"h-4 w-4"})}},w=async(s,t)=>{try{await x(s,t),l()}catch(a){console.error("Error updating quote status:",a),alert("Erreur lors de la mise à jour du statut du devis")}},D=async s=>{if(confirm("Êtes-vous sûr de vouloir convertir ce devis en vente ? Cette action est irréversible."))try{const t=await p(s);alert(`Devis converti en vente avec succès! Numéro de vente: ${t}`),l()}catch(t){console.error("Error converting quote to sale:",t),alert("Erreur lors de la conversion du devis en vente")}},T=s=>{v(s),S(!0)};return N?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:`text-2xl font-semibold ${r?"text-white":"text-gray-900"}`,children:"Gestion des Devis"}),e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("span",{className:`text-sm ${r?"text-gray-400":"text-gray-600"}`,children:[$.length," devis"]})})]}),u&&k&&e.jsx(J,{data:H(k),onClose:()=>{S(!1),v(null)},initialFormat:"a4"}),j&&A&&e.jsx(ie,{quote:A,clients:Q,onClose:()=>{g(!1),f(null)},onSave:async s=>{console.log("=== QUOTE SAVE START ==="),console.log("Original updatedQuote:",s);try{const{id:t,...a}=s,i=Object.fromEntries(Object.entries(a).filter(([n,c])=>c!==void 0));console.log("Quote ID:",t),console.log("Original quote data:",a),console.log("Clean quote data:",i),console.log("Calling updateQuote..."),await C(t,i),console.log("updateQuote completed successfully"),alert("Devis mis à jour avec succès!"),g(!1),f(null),l()}catch(t){console.error("=== QUOTE SAVE ERROR ==="),console.error("Error updating quote:",t),alert("Erreur lors de la mise à jour du devis")}}}),e.jsx("div",{className:`rounded-lg ${r?"bg-gray-800":"bg-white"} shadow p-6`,children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:`flex items-center gap-2 p-3 rounded-lg ${r?"bg-gray-700":"bg-gray-50"}`,children:[e.jsx(q,{className:"h-5 w-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Rechercher par numéro de devis, client, produit...",value:o,onChange:s=>E(s.target.value),className:`flex-1 bg-transparent border-0 focus:ring-0 ${r?"text-white placeholder-gray-400":"text-gray-900 placeholder-gray-500"}`})]})}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:`text-sm font-medium ${r?"text-gray-300":"text-gray-700"}`,children:"Statut:"}),e.jsxs("select",{value:y,onChange:s=>b(s.target.value),className:`px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500 ${r?"bg-gray-700 border-gray-600 text-white":"bg-white border-gray-300 text-gray-900"}`,children:[e.jsx("option",{value:"all",children:"Tous"}),e.jsx("option",{value:"draft",children:"Brouillon"}),e.jsx("option",{value:"sent",children:"Envoyé"}),e.jsx("option",{value:"accepted",children:"Accepté"}),e.jsx("option",{value:"rejected",children:"Rejeté"}),e.jsx("option",{value:"expired",children:"Expiré"})]})]}),e.jsxs("button",{onClick:()=>M(m==="desc"?"asc":"desc"),className:`flex items-center gap-2 px-3 py-2 rounded-md border ${r?"border-gray-600 text-gray-300 hover:bg-gray-700":"border-gray-300 text-gray-700 hover:bg-gray-50"}`,title:`Trier par date (${m==="desc"?"Plus récent d'abord":"Plus ancien d'abord"})`,children:[m==="desc"?e.jsx(ee,{className:"h-4 w-4"}):e.jsx(te,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-sm",children:["Date ",m==="desc"?"↓":"↑"]})]})]})]})}),e.jsx("div",{className:`rounded-lg ${r?"bg-gray-800":"bg-white"} shadow overflow-hidden`,children:$.length===0?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:`text-lg ${r?"text-gray-400":"text-gray-500"}`,children:h.length===0?"Aucun devis trouvé.":"Aucun devis ne correspond à vos filtres."})}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:`min-w-full divide-y ${r?"divide-gray-700":"divide-gray-200"}`,children:[e.jsx("thead",{className:r?"bg-gray-700":"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${r?"text-gray-300":"text-gray-500"}`,children:"Devis"}),e.jsx("th",{className:`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${r?"text-gray-300":"text-gray-500"}`,children:"Client"}),e.jsx("th",{className:`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${r?"text-gray-300":"text-gray-500"}`,children:"Statut"}),e.jsx("th",{className:`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${r?"text-gray-300":"text-gray-500"}`,children:"Total"}),e.jsx("th",{className:`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${r?"text-gray-300":"text-gray-500"}`,children:"Validité"}),e.jsx("th",{className:`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${r?"text-gray-300":"text-gray-500"}`,children:"Actions"})]})}),e.jsx("tbody",{className:`divide-y ${r?"bg-gray-800 divide-gray-700":"bg-white divide-gray-200"}`,children:$.map(s=>{var t;return e.jsxs("tr",{className:r?"hover:bg-gray-700":"hover:bg-gray-50",children:[e.jsxs("td",{className:`px-6 py-4 whitespace-nowrap text-sm font-medium ${r?"text-white":"text-gray-900"}`,children:[s.quoteNumber,e.jsx("br",{}),e.jsx("span",{className:"text-xs text-gray-500",children:B(new Date(s.createdAt),"dd/MM/yyyy")})]}),e.jsx("td",{className:`px-6 py-4 whitespace-nowrap text-sm ${r?"text-gray-300":"text-gray-500"}`,children:((t=s.customer)==null?void 0:t.name)||"Client sans rendez-vous"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${I(s.status)}`,children:[L(s.status),s.status==="draft"?"Brouillon":s.status==="sent"?"Envoyé":s.status==="accepted"?"Accepté":s.status==="rejected"?"Rejeté":s.status==="expired"?"Expiré":s.status]})}),e.jsxs("td",{className:`px-6 py-4 whitespace-nowrap text-sm font-medium ${r?"text-white":"text-gray-900"}`,children:["€",s.total.toFixed(2)]}),e.jsx("td",{className:`px-6 py-4 whitespace-nowrap text-sm ${r?"text-gray-300":"text-gray-500"}`,children:B(new Date(s.validUntil),"dd/MM/yyyy")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>T(s),className:"text-indigo-600 hover:text-indigo-900 p-1",title:"Voir le devis",children:e.jsx(se,{className:"h-4 w-4"})}),(s.status==="draft"||s.status==="sent")&&e.jsx("button",{onClick:()=>{f({...s}),g(!0)},className:"text-blue-600 hover:text-blue-900 p-1",title:"Modifier le devis",children:e.jsx(ae,{className:"h-4 w-4"})}),s.status==="draft"&&e.jsx("button",{onClick:()=>w(s.id,"sent"),className:"text-blue-600 hover:text-blue-900 p-1",title:"Marquer comme envoyé",children:e.jsx(R,{className:"h-4 w-4"})}),s.status==="sent"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>w(s.id,"accepted"),className:"text-green-600 hover:text-green-900 p-1",title:"Accepter le devis",children:e.jsx(V,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>w(s.id,"rejected"),className:"text-red-600 hover:text-red-900 p-1",title:"Rejeter le devis",children:e.jsx(U,{className:"h-4 w-4"})})]}),s.status==="accepted"&&!s.convertedToSaleId&&e.jsx("button",{onClick:()=>D(s.id),className:"text-purple-600 hover:text-purple-900 p-1",title:"Convertir en vente",children:e.jsx(re,{className:"h-4 w-4"})}),s.convertedToSaleId&&e.jsxs("span",{className:"text-xs text-green-600 font-medium",children:["→ Vente #",s.convertedToSaleId.slice(-6)]})]})})]},s.id)})})]})})})]})}export{ge as default};
