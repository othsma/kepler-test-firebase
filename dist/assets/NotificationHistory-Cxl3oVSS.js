import{j as e}from"./vendor-pdf-renderer-Bmei4UPz.js";import{r as d}from"./vendor-react-DSd34EeT.js";import{u as re,t as se,n as f}from"./index-Bitl2p2P.js";import{q,N as F,M as V,w as _,l as R,v as z,P as ie,r as S,d as D}from"./vendor-firebase-BtFjE0-F.js";import{D as oe,n as ne,B as k,a8 as le,Q as ce,aa as de,l as ue,j as me}from"./vendor-ui-Cgar-0cM.js";import"./vendor-utils-Bnff-AKO.js";import"./vendor-pdf-utils-CBrSDip1.js";function be(){const r=re(t=>t.isDarkMode),{user:n}=se(),[b,I]=d.useState([]),[B,N]=d.useState(!0),[he,P]=d.useState(null),[E,C]=d.useState(null),[M,T]=d.useState(!0),[v,Q]=d.useState(""),[w,U]=d.useState("all"),[A,O]=d.useState("all"),[m,G]=d.useState("all");d.useEffect(()=>{if(!(n!=null&&n.uid)){console.log("âŒ NotificationHistory: No user UID");return}console.log("ðŸ” NotificationHistory: Starting for user:",n.uid),N(!0);const t=q(R(f,"notification_history"),_("customerId","==",n.uid),V("sentAt","desc"),F(20));return console.log("ðŸ” NotificationHistory: Query created"),z(t,i=>{console.log("ðŸ” NotificationHistory: Snapshot received, docs count:",i.docs.length);const c=[];i.forEach(s=>{var h,x,g,y,p,L,H;const a=s.data();console.log("ðŸ” NotificationHistory: Notification data:",a);let l="",u="";a.type==="status_change"?(l="Statut de rÃ©paration mis Ã  jour",u=`Votre ${((h=a.metadata)==null?void 0:h.deviceInfo)||"appareil"} est maintenant ${((x=a.metadata)==null?void 0:x.newStatus)||"mis Ã  jour"}`):a.type==="email"?(l="Notification par email",u=`Mise Ã  jour rÃ©paration - ${((g=a.metadata)==null?void 0:g.deviceInfo)||"appareil"}`):a.channel==="push"?(l="Notification push",u="Votre rÃ©paration a Ã©tÃ© mise Ã  jour"):(l=`Notification ${a.channel||"gÃ©nÃ©rale"}`,u="Vous avez une nouvelle notification");let j=((y=a.metadata)==null?void 0:y.ticketNumber)||a.ticketId;c.push({id:s.id,customerId:a.customerId,type:a.channel||a.type||"push",title:l,message:u,ticketId:a.ticketId,ticketNumber:j,status:a.status,createdAt:((p=a.sentAt)==null?void 0:p.toDate())||new Date,deliveredAt:(L=a.deliveredAt)==null?void 0:L.toDate(),readAt:(H=a.readAt)==null?void 0:H.toDate()})}),console.log("ðŸ” NotificationHistory: Processed notifications:",c.length),I(c),C(i.docs[i.docs.length-1]),T(i.docs.length===20),N(!1)},i=>{console.error("ðŸ” NotificationHistory: Error fetching notifications:",i),P("Erreur lors du chargement des notifications"),N(!1)})},[n==null?void 0:n.uid]);const J=()=>{if(!(n!=null&&n.uid)||!E||!M)return;const t=q(R(f,"notification_history"),_("customerId","==",n.uid),V("sentAt","desc"),ie(E),F(20));z(t,o=>{const i=[];o.forEach(c=>{var u,j,h,x,g,y,p;const s=c.data();let a="",l="";s.type==="status_change"?(a="Statut de rÃ©paration mis Ã  jour",l=`Votre ${((u=s.metadata)==null?void 0:u.deviceInfo)||"appareil"} est maintenant ${((j=s.metadata)==null?void 0:j.newStatus)||"mis Ã  jour"}`):s.type==="email"?(a="Notification par email",l=`Mise Ã  jour rÃ©paration - ${((h=s.metadata)==null?void 0:h.deviceInfo)||"appareil"}`):s.channel==="push"?(a="Notification push",l="Votre rÃ©paration a Ã©tÃ© mise Ã  jour"):(a=`Notification ${s.channel||"gÃ©nÃ©rale"}`,l="Vous avez une nouvelle notification"),i.push({id:c.id,customerId:s.customerId,type:s.channel||s.type||"push",title:a,message:l,ticketId:s.ticketId,ticketNumber:((x=s.metadata)==null?void 0:x.ticketNumber)||s.ticketId,status:s.status,createdAt:((g=s.sentAt)==null?void 0:g.toDate())||new Date,deliveredAt:(y=s.deliveredAt)==null?void 0:y.toDate(),readAt:(p=s.readAt)==null?void 0:p.toDate()})}),I(c=>[...c,...i]),C(o.docs[o.docs.length-1]),T(o.docs.length===20)})},K=async t=>{try{await S(D(f,"notification_history",t),{readAt:new Date})}catch(o){console.error("Error marking notification as read:",o)}},W=async t=>{try{await S(D(f,"notification_history",t),{readAt:null})}catch(o){console.error("Error marking notification as unread:",o)}},X=async t=>{try{await S(D(f,"notification_history",t),{archived:!0})}catch(o){console.error("Error archiving notification:",o)}},$=b.filter(t=>{const o=v===""||t.title.toLowerCase().includes(v.toLowerCase())||t.message.toLowerCase().includes(v.toLowerCase()),i=w==="all"||t.type===w,c=A==="all"||t.status===A,s=m==="all"||m==="today"&&new Date(t.createdAt).toDateString()===new Date().toDateString()||m==="week"&&t.createdAt>=new Date(Date.now()-7*24*60*60*1e3)||m==="month"&&t.createdAt>=new Date(Date.now()-30*24*60*60*1e3);return o&&i&&c&&s}),Y=t=>{switch(t){case"push":return e.jsx(me,{className:"h-4 w-4 text-blue-500"});case"email":return e.jsx(ue,{className:"h-4 w-4 text-green-500"});case"sms":return e.jsx(k,{className:"h-4 w-4 text-purple-500"});default:return e.jsx(k,{className:"h-4 w-4 text-gray-500"})}},Z=t=>{switch(t){case"push":return"Notification push";case"email":return"Email";case"sms":return"SMS";default:return t}},ee=(t,o)=>{if(o)return"Lu";switch(t){case"sent":return"EnvoyÃ©";case"delivered":return"LivrÃ©";case"failed":return"Ã‰chec";default:return t}},te=t=>t.toLocaleDateString("fr-FR",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}),ae=t=>{const i=Math.floor((new Date().getTime()-t.getTime())/(1e3*60*60));return i<1?"Ã€ l'instant":i<24?`Il y a ${i}h`:i<24*7?`Il y a ${Math.floor(i/24)}j`:te(t)};return B&&b.length===0?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"Chargement des notifications..."})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:`rounded-lg shadow p-6 ${r?"bg-gray-800":"bg-white"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:`text-2xl font-bold ${r?"text-white":"text-gray-900"}`,children:"Historique des Notifications"}),e.jsx("p",{className:`text-sm ${r?"text-gray-400":"text-gray-500"} mt-1`,children:"Toutes vos communications et mises Ã  jour"})]}),e.jsx("div",{className:"flex items-center space-x-3",children:e.jsxs("button",{className:`inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md ${r?"text-gray-300 bg-gray-700 hover:bg-gray-600":"text-gray-700 bg-white hover:bg-gray-50"} border-gray-300`,children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),"Exporter"]})})]})}),e.jsx("div",{className:`rounded-lg shadow p-6 ${r?"bg-gray-800":"bg-white"}`,children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ne,{className:"absolute left-3 top-3 h-4 w-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Rechercher...",value:v,onChange:t=>Q(t.target.value),className:`w-full pl-10 pr-3 py-2 border rounded-md ${r?"bg-gray-700 border-gray-600 text-white placeholder-gray-400":"bg-white border-gray-300 text-gray-900"}`})]}),e.jsx("div",{children:e.jsxs("select",{value:w,onChange:t=>U(t.target.value),className:`w-full px-3 py-2 border rounded-md ${r?"bg-gray-700 border-gray-600 text-white":"bg-white border-gray-300 text-gray-900"}`,children:[e.jsx("option",{value:"all",children:"Tous les types"}),e.jsx("option",{value:"push",children:"Notifications push"}),e.jsx("option",{value:"email",children:"Emails"}),e.jsx("option",{value:"sms",children:"SMS"})]})}),e.jsx("div",{children:e.jsxs("select",{value:A,onChange:t=>O(t.target.value),className:`w-full px-3 py-2 border rounded-md ${r?"bg-gray-700 border-gray-600 text-white":"bg-white border-gray-300 text-gray-900"}`,children:[e.jsx("option",{value:"all",children:"Tous les statuts"}),e.jsx("option",{value:"sent",children:"EnvoyÃ©"}),e.jsx("option",{value:"delivered",children:"LivrÃ©"}),e.jsx("option",{value:"failed",children:"Ã‰chec"})]})}),e.jsx("div",{children:e.jsxs("select",{value:m,onChange:t=>G(t.target.value),className:`w-full px-3 py-2 border rounded-md ${r?"bg-gray-700 border-gray-600 text-white":"bg-white border-gray-300 text-gray-900"}`,children:[e.jsx("option",{value:"all",children:"Toutes les dates"}),e.jsx("option",{value:"today",children:"Aujourd'hui"}),e.jsx("option",{value:"week",children:"Cette semaine"}),e.jsx("option",{value:"month",children:"Ce mois"})]})})]})}),e.jsxs("div",{className:`rounded-lg shadow ${r?"bg-gray-800":"bg-white"}`,children:[e.jsx("div",{className:"divide-y divide-gray-200",children:$.length===0?e.jsxs("div",{className:"px-6 py-12 text-center",children:[e.jsx(k,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:`text-lg font-medium ${r?"text-white":"text-gray-900"} mb-2`,children:"Aucune notification"}),e.jsx("p",{className:`text-sm ${r?"text-gray-400":"text-gray-500"}`,children:b.length===0?"Vous n'avez pas encore reÃ§u de notifications.":"Aucune notification ne correspond Ã  vos critÃ¨res de recherche."})]}):$.map(t=>e.jsx("div",{className:`px-6 py-4 hover:bg-gray-50 transition-colors ${t.readAt?"opacity-75":""} ${r?"hover:bg-gray-700":""}`,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start space-x-3 flex-1",children:[e.jsx("div",{className:"flex-shrink-0 mt-1",children:Y(t.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsx("h3",{className:`text-sm font-medium ${t.readAt?r?"text-gray-400":"text-gray-600":r?"text-white":"text-gray-900"}`,children:t.title}),e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${t.readAt?"bg-gray-100 text-gray-600":"bg-indigo-100 text-indigo-800"}`,children:Z(t.type)}),e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${t.status==="delivered"?"bg-green-100 text-green-800":t.status==="failed"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:ee(t.status,t.readAt)})]}),e.jsx("p",{className:`text-sm ${t.readAt?r?"text-gray-500":"text-gray-600":r?"text-gray-300":"text-gray-700"} mb-2`,children:t.message}),e.jsxs("div",{className:`text-xs ${r?"text-gray-400":"text-gray-500"} space-y-1`,children:[e.jsx("p",{children:ae(t.createdAt)}),t.ticketNumber&&e.jsxs("p",{children:["RÃ©paration #",t.ticketNumber]})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 ml-4",children:[t.readAt?e.jsx("button",{onClick:()=>W(t.id),className:`p-1 rounded-md ${r?"hover:bg-gray-700":"hover:bg-gray-100"}`,title:"Marquer comme non lu",children:e.jsx(le,{className:"h-4 w-4 text-gray-400"})}):e.jsx("button",{onClick:()=>K(t.id),className:`p-1 rounded-md ${r?"hover:bg-gray-700":"hover:bg-gray-100"}`,title:"Marquer comme lu",children:e.jsx(ce,{className:"h-4 w-4 text-blue-500"})}),e.jsx("button",{onClick:()=>X(t.id),className:`p-1 rounded-md ${r?"hover:bg-gray-700":"hover:bg-gray-100"}`,title:"Archiver",children:e.jsx(de,{className:"h-4 w-4 text-gray-400"})})]})]})},t.id))}),M&&$.length>0&&e.jsx("div",{className:"px-6 py-4 border-t border-gray-200 text-center",children:e.jsx("button",{onClick:J,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-600 bg-indigo-50 hover:bg-indigo-100",children:"Charger plus"})})]})]})}export{be as default};
